name: "$(SourceBranchName)+$(BuildID)"

trigger:
  branches:
    include:
      - tags/refs/v*
  tags:
    include:
      - v*

pr:
  branches:
    include: ['*']

pool:
  name: 'AWS-ECS'


stages:

  - stage: build
    displayName: Build and Test
    jobs:
      - job: build
        displayName: Build and Test
        timeoutInMinutes: 40

        pool:
          name: 'AWS-ECS'

        workspace:
          clean: all

        steps:
          - checkout: self

          - bash: |
              instance_id="$(curl -s http://169.254.169.254/latest/meta-data/instance-id)"
              echo instance-id: "${instance_id}"
              echo connect to: https://eu-west-2.console.aws.amazon.com/systems-manager/session-manager/${instance_id}
              echo sudo su - ubuntu
              echo working directory: $(System.DefaultWorkingDirectory)
            displayName: Print AWS info

          - task: UsePythonVersion@0
            displayName: "Use Python 3.8"
            inputs:
              versionSpec: "3.8"

          - task: NodeTool@0
            displayName: "Use Node 13"
            inputs:
              versionSpec: '13.x'

          - task: s3-cache-action@0
            inputs:
              key: 'node | s3CacheTask/package-lock.json'
              location: 's3CacheTask/node_modules'
              # pipelineIsolated: false
              debug: false
            displayName: cache node modules

          - bash: make install-node
            condition: ne(variables.CacheRestored, 'true')
            displayName: Install node dependencies

          - task: s3-cache-action@0
            inputs:
              key: 'python venv | ./poetry.lock'
              location: '.venv'
              # pipelineIsolated: false
              debug: false
            displayName: cache virtual env

          - bash: make install-poetry
            condition: ne(variables.CacheRestored, 'true')
            displayName: Install poetry dependencies

          - bash: |
              make test
              exit_code=$?
              echo Exit code - ${exit_code}
              make down
              cd scripts
              export VIRTUAL_ENV_PATH="../.venv"
              sh check-python-venv-fixed.sh
              exit ${exit_code}
            displayName: Run s3 tests
